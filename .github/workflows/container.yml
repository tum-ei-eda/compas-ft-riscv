name: Build single compas-ft-riscv docker image
on:
  workflow_dispatch:
    inputs:
      compas-ft-riscv-ref:
        description: docker version/tag/branch
        required: true
        default: default
      full:
        description: Also build large quickstart image
        required: true
        type: boolean
        # default: "false"
      base-image:
        description: OS base image
        required: true
        default: debian:stable

jobs:
  image-deps:
    name: Build minimal compas-ft-riscv-deps image
    runs-on: ubuntu-latest
    steps:
      - name: Remove unused software
        run: |
          echo "Available storage before:"
          sudo df -h
          echo
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --force
          sudo docker builder prune
          echo "Available storage after:"
          sudo df -h
          echo
      - name: Set current date as env variable
        run: |
          echo "builddate=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        id: timestamp
      - name: Set os env variable
        run: |
          echo "os=$(echo '${{ github.event.inputs.base-image }}' | tr ':' '-')" >> $GITHUB_OUTPUT
        id: os
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Load env vars from docker/.env
        run: |
          while IFS='=' read -r key value || [ -n "$key" ]; do
            [[ -z "$key" || "$key" == \#* ]] && continue
            key="$(echo "$key" | xargs)"
            value="$(echo "$value" | xargs)"
            value="${value%\"}"
            value="${value#\"}"
            echo "$key=$value" >> $GITHUB_ENV
          done < docker/.env
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        if: ${{ github.repository == 'tum-ei-eda/compas-ft-riscv' }}
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        if: ${{ github.repository == 'tum-ei-eda/compas-ft-riscv' }}
        with:
          context: .
          file: docker/dockerfile
          pull: true
          push: true
          target: compas-ft-riscv-deps
          build-args: |
            BASE_IMAGE=${{ github.event.inputs.base-image }}
            workspace_dir=${{ env.workspace_dir }}
            ENV_LLVM_FROM_SOURCE=${{ env.ENV_LLVM_FROM_SOURCE }}
            ENV_LLVM_VERSION=${{ env.ENV_LLVM_VERSION }}
            ENV_BUILD_CONFIG=${{ env.ENV_BUILD_CONFIG }}
            ENV_BUILD_CXX_STANDARD=${{ env.ENV_BUILD_CXX_STANDARD }}
          cache-to: type=inline
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/compas-ft-riscv-deps:${{ steps.timestamp.outputs.builddate }}-${{ github.event.inputs.compas-ft-riscv-ref }}-${{ steps.os.outputs.os }}
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/compas-ft-riscv-deps:latest-${{ github.event.inputs.compas-ft-riscv-ref }}-${{ steps.os.outputs.os }}

  image-base:
    name: Build compas-ft-riscv-dev image for users
    runs-on: ubuntu-latest
    needs: image-deps
    steps:
      - name: Set current date as env variable
        run: |
          echo "builddate=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        id: timestamp
      - name: Set os env variable
        run: |
          echo "os=$(echo '${{ github.event.inputs.base-image }}' | tr ':' '-')" >> $GITHUB_OUTPUT
        id: os
      - name: Remove unused software
        run: |
          echo "Available storage before:"
          sudo df -h
          echo
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --force
          sudo docker builder prune
          echo "Available storage after:"
          sudo df -h
          echo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        if: ${{ github.repository == 'tum-ei-eda/compas-ft-riscv' }}
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        if: ${{ github.repository == 'tum-ei-eda/compas-ft-riscv' }}
        with:
          context: .
          file: docker/Dockerfile
          pull: true
          push: true
          target: compas-ft-riscv-dev
          build-args: |
            BASE_IMAGE=${{ github.event.inputs.base-image }}
            workspace_dir=${{ env.workspace_dir }}
            ENV_LLVM_FROM_SOURCE=${{ env.ENV_LLVM_FROM_SOURCE }}
            ENV_LLVM_VERSION=${{ env.ENV_LLVM_VERSION }}
            ENV_BUILD_CONFIG=${{ env.ENV_BUILD_CONFIG }}
            ENV_BUILD_CXX_STANDARD=${{ env.ENV_BUILD_CXX_STANDARD }}
          cache-from: |
            type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/compas-ft-riscv-deps:${{ steps.timestamp.outputs.builddate }}-${{ github.event.inputs.compas-ft-riscv-deps }}-${{ steps.os.outputs.os }}
          cache-to: type=inline
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/compas-ft-riscv-dev:${{ steps.timestamp.outputs.builddate }}-${{ github.event.inputs.compas-ft-riscv-ref }}-${{ steps.os.outputs.os }}
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/compas-ft-riscv-dev:latest-${{ github.event.inputs.compas-ft-riscv-ref }}-${{ steps.os.outputs.os }}